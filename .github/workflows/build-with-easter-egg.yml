name: Build APK with Easter Egg Configuration

# åªå…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œä¸ä¼šè‡ªåŠ¨è¿è¡Œ
on:
  workflow_dispatch:
    inputs:
      action_type:
        description: 'ðŸŽ¯ åŽç½®æ“ä½œç±»åž‹'
        required: true
        default: 'none'
        type: choice
        options:
          - none
          - app
          - url
      target_package:
        description: 'ðŸ“± åº”ç”¨åŒ…å (å½“é€‰æ‹©appæ—¶å¡«å†™ï¼Œä¾‹å¦‚: com.tencent.mm)'
        required: false
        type: string
        default: ''
      target_url:
        description: 'ðŸŒ ç›®æ ‡ç½‘å€ (å½“é€‰æ‹©urlæ—¶å¡«å†™ï¼Œä¾‹å¦‚: https://www.baidu.com)'
        required: false
        type: string
        default: ''
      app_name:
        description: 'ðŸ·ï¸ åº”ç”¨æ˜¾ç¤ºåç§° (å¯é€‰ï¼Œä¾‹å¦‚: å¾®ä¿¡)'
        required: false
        type: string
        default: ''
      build_type:
        description: 'ðŸ—ï¸ æž„å»ºç±»åž‹'
        required: true
        default: 'apk'
        type: choice
        options:
          - apk
          - aab

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        
    - name: Clean Android Java directory (force V2 embedding)
      run: rm -rf android/app/src/main/java
      
    - name: Get dependencies
      run: flutter pub get
      
    - name: Build App with Easter Egg Configuration
      run: |
        BUILD_ARGS=""
        BUILD_TYPE="${{ github.event.inputs.build_type }}"
        
        # æž„å»ºå½©è›‹é…ç½®å‚æ•°
        if [ "${{ github.event.inputs.action_type }}" != "none" ]; then
          BUILD_ARGS="--dart-define=EASTER_EGG_ACTION_TYPE=${{ github.event.inputs.action_type }}"
          
          if [ "${{ github.event.inputs.action_type }}" = "app" ] && [ -n "${{ github.event.inputs.target_package }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --dart-define=EASTER_EGG_TARGET_PACKAGE=${{ github.event.inputs.target_package }}"
            
            if [ -n "${{ github.event.inputs.app_name }}" ]; then
              BUILD_ARGS="$BUILD_ARGS --dart-define=EASTER_EGG_SELECTED_APP_NAME=${{ github.event.inputs.app_name }}"
            fi
          elif [ "${{ github.event.inputs.action_type }}" = "url" ] && [ -n "${{ github.event.inputs.target_url }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --dart-define=EASTER_EGG_TARGET_URL=${{ github.event.inputs.target_url }}"
          fi
        fi
        
        echo "ðŸ—ï¸ æž„å»ºç±»åž‹: $BUILD_TYPE"
        echo "âš™ï¸ æž„å»ºå‚æ•°: $BUILD_ARGS"
        
        # æ ¹æ®é€‰æ‹©çš„ç±»åž‹æ‰§è¡Œæž„å»º
        if [ "$BUILD_TYPE" = "aab" ]; then
          echo "ðŸ“¦ æž„å»º Android App Bundle (AAB)..."
          flutter build appbundle $BUILD_ARGS
        else
          echo "ðŸ“± æž„å»º Android APK..."
          flutter build apk $BUILD_ARGS
        fi
        
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: scantopda-${{ github.event.inputs.build_type }}-with-easter-egg
        path: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/bundle/release/app-release.aab
        
    - name: Create Release Summary
      run: |
        echo "## ðŸŽ‰ æž„å»ºå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ æž„å»ºä¿¡æ¯:" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºç±»åž‹:** ${{ github.event.inputs.build_type == 'aab' && 'Android App Bundle (AAB)' || 'Android APK' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ¥š å½©è›‹é…ç½®:" >> $GITHUB_STEP_SUMMARY
        echo "- **æ“ä½œç±»åž‹:** ${{ github.event.inputs.action_type }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.inputs.action_type }}" = "app" ]; then
          echo "- **ç›®æ ‡åº”ç”¨:** ${{ github.event.inputs.app_name || 'è‡ªå®šä¹‰åº”ç”¨' }} (\`${{ github.event.inputs.target_package }}\`)" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ github.event.inputs.action_type }}" = "url" ]; then
          echo "- **ç›®æ ‡ç½‘å€:** ${{ github.event.inputs.target_url }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”“ å¦‚ä½•è®¿é—®å½©è›‹åŠŸèƒ½:" >> $GITHUB_STEP_SUMMARY
        echo "1. ðŸ“± å®‰è£…æž„å»ºçš„åº”ç”¨æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "2. â„¹ï¸ è¿›å…¥ã€Œå…³äºŽåº”ç”¨ã€é¡µé¢" >> $GITHUB_STEP_SUMMARY
        echo "3. ðŸ‘† è¿žç»­ç‚¹å‡»å¼€å‘è€…åç§° **10 æ¬¡**" >> $GITHUB_STEP_SUMMARY
        echo "4. âš™ï¸ è¿›å…¥å½©è›‹è®¾ç½®é¡µé¢é…ç½®æˆ–æŸ¥çœ‹é¢„è®¾é…ç½®" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‚ æ–‡ä»¶ä½ç½®:" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.build_type }}" = "aab" ]; then
          echo "- AAB æ–‡ä»¶: \`build/app/outputs/bundle/release/app-release.aab\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "- APK æ–‡ä»¶: \`build/app/outputs/flutter-apk/app-release.apk\`" >> $GITHUB_STEP_SUMMARY
        fi
