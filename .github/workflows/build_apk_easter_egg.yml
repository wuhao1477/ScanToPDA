name: Build and Release ScanToPDA APK

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: "Easter egg action type (app|url)"
        required: true
        default: 'none'
        type: choice
        options:
          - none
          - app
          - url
      target:
        description: "ğŸŒ ç›®æ ‡ç½‘å€ æˆ– ğŸ“± åº”ç”¨åŒ…å "
        required: false
        type: string
        default: ''
      create_release:
        description: "ä¸ºæ­¤è¿è¡Œåˆ›å»º GitHub Release"
        required: true
        default: 'false'
        type: choice
        options:
          - true
          - false
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # æ„å»ºé˜¶æ®µåªéœ€è¦è¯»å–æƒé™
    outputs:
      # å®šä¹‰è¾“å‡ºï¼Œç”¨äºå°†åŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶åä¼ é€’ç»™ release job
      apk_filename: ${{ steps.pubspec.outputs.apk_filename }}
      app_name: ${{ steps.pubspec.outputs.app_name }}
      app_version: ${{ steps.pubspec.outputs.app_version }}
      checksum: ${{ steps.checksum.outputs.checksum }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.35.2"
          cache: true

      - name: Install yq for YAML parsing
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
          yq --version

      - name: Extract app name and version from pubspec.yaml
        id: pubspec
        run: |
          # ä½¿ç”¨yqå¯é åœ°è§£æYAMLæ–‡ä»¶
          APP_NAME=$(yq -r '.name' pubspec.yaml)
          FULL_VERSION=$(yq -r '.version' pubspec.yaml)

          # æå–ä¸»ç‰ˆæœ¬å·ï¼ˆå»æ‰æ„å»ºå·ï¼‰
          APP_VERSION=$(echo "$FULL_VERSION" | cut -d'+' -f1)

          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_ENV

          # æ„é€ APKæ–‡ä»¶å
          APK_FILENAME="${APP_NAME}-v${APP_VERSION}.apk"
          echo "apk_filename=$APK_FILENAME" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
          
          echo "âœ… æå–çš„ä¿¡æ¯:"
          echo "åº”ç”¨åç§°: $APP_NAME"
          echo "åº”ç”¨ç‰ˆæœ¬: $APP_VERSION" 
          echo "APKæ–‡ä»¶å: $APK_FILENAME"

      - name: Show environment info
        run: |
          flutter --version
          dart --version || true
          echo "GITHUB_REF: $GITHUB_REF"
          echo "åº”ç”¨åç§°: ${{ env.APP_NAME }}"
          echo "åº”ç”¨ç‰ˆæœ¬: ${{ env.APP_VERSION }}"

      - name: Make script executable
        run: chmod +x ./build_with_easter_egg.sh

      - name: Clean Flutter cache
        run: |
          flutter clean
          flutter pub cache clean

      - name: Build APK (non-interactive)
        shell: bash
        run: |
          set -euxo pipefail

          # å¤„ç†è¾“å…¥å‚æ•°ï¼šæ ‡ç­¾è§¦å‘æ—¶ä½¿ç”¨é»˜è®¤å€¼
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # æ ‡ç­¾è§¦å‘ï¼Œæ€»æ˜¯ä½¿ç”¨ none å’Œç©ºç›®æ ‡
            ACTION_TYPE="none"
            TARGET=""
            echo "ğŸ·ï¸ æ ‡ç­¾è§¦å‘æ„å»ºï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          else
            # æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨è¾“å…¥å‚æ•°
            ACTION_TYPE="${{ github.event.inputs.action_type }}"
            TARGET="${{ github.event.inputs.target }}"
            echo "ğŸ”§ æ‰‹åŠ¨è§¦å‘æ„å»ºï¼Œä½¿ç”¨è‡ªå®šä¹‰é…ç½®"
          fi

          echo "ğŸ“‹ æ„å»ºå‚æ•°: ACTION_TYPE=$ACTION_TYPE, TARGET=$TARGET"

          # å¦‚æœæ“ä½œç±»å‹ä¸º 'none' æˆ–ä¸ºç©ºï¼Œåˆ™æ„å»ºæ ‡å‡† APKï¼ˆæ— å½©è›‹é…ç½®ï¼‰
          if [ "$ACTION_TYPE" = "none" ] || [ -z "$ACTION_TYPE" ]; then
            echo "ğŸ“± æ„å»ºæ ‡å‡† APKï¼ˆæ— å½©è›‹é…ç½®ï¼‰..."
            flutter clean
            flutter pub get
            flutter build apk --release
            echo "âœ… æ ‡å‡† APK æ„å»ºå®Œæˆï¼"
            echo "APK ä½ç½®: build/app/outputs/flutter-apk/app-release.apk"
          else
            # ä½¿ç”¨å½©è›‹é…ç½®æ„å»º
            ./build_with_easter_egg.sh "$ACTION_TYPE" "$TARGET"
          fi

      - name: Rename APK with version
        run: |
          cd build/app/outputs/flutter-apk/
          # é‡å‘½åAPKæ–‡ä»¶ä¸ºç‰ˆæœ¬åŒ–åç§°
          NEW_NAME="${{ steps.pubspec.outputs.apk_filename }}"
          cp app-release.apk "$NEW_NAME"
          echo "âœ… APKå·²é‡å‘½åä¸º: $NEW_NAME"
          ls -la "$NEW_NAME"

      - name: Generate checksum
        id: checksum
        run: |
          cd build/app/outputs/flutter-apk/
          APK_FILE="${{ steps.pubspec.outputs.apk_filename }}"
          # ç”ŸæˆSHA256æ ¡éªŒå’Œ
          CHECKSUM=$(sha256sum "$APK_FILE" | cut -d' ' -f1)
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "âœ… SHA256æ ¡éªŒå’Œ: $CHECKSUM"
          
          # åˆ›å»ºæ ¡éªŒå’Œæ–‡ä»¶
          echo "$CHECKSUM  $APK_FILE" > "${APK_FILE}.sha256"
          echo "âœ… æ ¡éªŒå’Œæ–‡ä»¶å·²åˆ›å»º: ${APK_FILE}.sha256"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: versioned-apk
          path: |
            build/app/outputs/flutter-apk/${{ steps.pubspec.outputs.apk_filename }}
            build/app/outputs/flutter-apk/${{ steps.pubspec.outputs.apk_filename }}.sha256

  release:
    # ä»…åœ¨æ¨é€æ ‡ç­¾æˆ–æ‰‹åŠ¨è°ƒåº¦å¹¶é€‰æ‹©åˆ›å»ºreleaseæ—¶è¿è¡Œ
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    needs: build-apk
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å‘å¸ƒéœ€è¦å†™å…¥æƒé™
    steps:
      - name: Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          name: versioned-apk
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # å¦‚æœæ˜¯æ ‡ç­¾è§¦å‘ï¼Œä½¿ç”¨æ ‡ç­¾åï¼›å¦åˆ™ï¼Œä¸ºæ‰‹åŠ¨æ„å»ºç”Ÿæˆå”¯ä¸€åç§°
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}-manual-{1}', needs.build-apk.outputs.app_version, github.run_number) }}
          name: ${{ needs.build-apk.outputs.app_name }} ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0} (Manual Build {1})', needs.build-apk.outputs.app_version, github.run_number) }}
          body: |
            ## ğŸ“± ${{ needs.build-apk.outputs.app_name }} ç‰ˆæœ¬ ${{ needs.build-apk.outputs.app_version }}
            
            ### ğŸš€ æ›´æ–°å†…å®¹
            - åŠŸèƒ½ä¼˜åŒ–å’Œé”™è¯¯ä¿®å¤
            - æ€§èƒ½æå‡å’Œä½“éªŒä¼˜åŒ–
            - è“ç‰™è¿æ¥ç¨³å®šæ€§æ”¹è¿›
            
            ### ğŸ” æ–‡ä»¶æ ¡éªŒ
            **SHA256æ ¡éªŒå’Œ**: `${{ needs.build-apk.outputs.checksum }}`
            
            ### ğŸ“¥ å®‰è£…è¯´æ˜
            1. ä¸‹è½½ APK æ–‡ä»¶åˆ°è®¾å¤‡
            2. åœ¨è®¾å¤‡è®¾ç½®ä¸­å…è®¸"å®‰è£…æœªçŸ¥åº”ç”¨"
            3. ç‚¹å‡» APK æ–‡ä»¶å¼€å§‹å®‰è£…
            4. äº«å—æ–°ç‰ˆæœ¬çš„åŠŸèƒ½ï¼
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - ä»…æ”¯æŒ Android 8.0 åŠä»¥ä¸Šç‰ˆæœ¬
            - é¦–æ¬¡å®‰è£…éœ€è¦æˆæƒ"å®‰è£…æœªçŸ¥åº”ç”¨"æƒé™
            - å»ºè®®åœ¨å®‰è£…å‰éªŒè¯æ–‡ä»¶æ ¡éªŒå’Œ
            
            ---
            **æ„å»ºä¿¡æ¯**: GitHub Actions è‡ªåŠ¨æ„å»º | æ„å»ºå·: ${{ github.run_number }}
          # å¦‚æœä¸æ˜¯ç”±æ ‡ç­¾è§¦å‘çš„ï¼Œåˆ™æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          files: |
            artifacts/${{ needs.build-apk.outputs.apk_filename }}
            artifacts/${{ needs.build-apk.outputs.apk_filename }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


